<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>멘토 구독과 알림 받는 테스트</title>
</head>
<body>
<h1>
    멘토 구독
</h1>
<div>
    <div>
        <h4>mentor1</h4>
        <button id="subscribe">구독</button>
    </div>
</div>
<h1>
    스케쥴링
</h1>
<div>
    <div>
        <h4>mentor1</h4>
        <button id="schedule">구독</button>
    </div>
</div>
<h1>멘토 발행</h1>
<div>
    <button id="publish">발행</button>
</div>
<h1>구독된 메시지 가져오기</h1>
<div>
    <button id="getSubscriptions">가져오기</button>
    <div id="messages"></div>
</div>
<script>
    const userId = "user1"; // 변경 가능한 사용자 ID
    const subscribeBtn = document.getElementById("subscribe");
    const publishBtn = document.getElementById("publish");
    const getSubscriptionsBtn = document.getElementById("getSubscriptions");
    const messagesDiv = document.getElementById("messages");
    const schedule = document.getElementById("schedule");

    let source = null;
    // sse 메시지 수신
    function subscribe() {
        if (source !== null) {
            // 이미 SSE 연결이 맺어져 있으면, 다시 맺지 않고 기존 연결을 계속 사용합니다.
            console.log(source);
            return;
        }
        source = new EventSource("http://localhost:8080/api/subscribe?mentorId=mentor1");

        source.onmessage = function (event) {
            console.log("Received message:", event.data);
            showNotification("새로운 알림: " + event.data);
        };

        source.onerror = function (event) {
            console.log("Error:", event);
        };
    }

    function showFallbackNotification(message) {
        alert(message);
    }

    function showNotification(message) {
        if (!("Notification" in window)) {
            console.error("This browser does not support desktop notifications.");
            showFallbackNotification("새로운 알림: " + message);
        } else if (Notification.permission === "granted") {
            new Notification(message);
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then((permission) => {
                if (permission === "granted") {
                    new Notification(message);
                }
            });
        }
    }

    // window.addEventListener("load", subscribe);

    schedule.addEventListener("click", () => {
        const mentorId = "mentor1";
        const time = "202304032310";
        const eventSource = new EventSource(`http://localhost:8080/api/subscribe/schedule?mentorId=${mentorId}&time=${time}`);

        eventSource.onmessage = (event) => {
            console.log("Message received: ", event.data);
            showNotification("새로운 알림: " + event.data);
        };

        eventSource.onerror = (error) => {
            console.error("Error: ", error);
        };
    });

    subscribeBtn.addEventListener("click", () => {
        fetch(`http://localhost:8080/api/subscribe?mentorId=mentor1`,{
            headers: {
                'Accept': 'text/event-stream'
            }})
            .then(res => {
                if(res.ok) {
                    console.log("메시지 수신 완료!")
                    subscribe();
                }else{
                    console.log("메시지 받을 수 없는 상태!")
                }
            })
            .catch(err => console.error(err));
    });

    publishBtn.addEventListener("click", () => {
        fetch("http://localhost:8080/api/publish?mentorId=mentor1")
            .then(res => console.log("메시지 발행 성공!"))
            .catch(err => console.error("메시지 발행 실패!"));
    });
</script>
</body>
</html>
